<!DOCTYPE html>
<html>
<head>
    <title>TITLE</title>
    <script src ="./js/jquery-2.1.1.min.js"
            type="text/javascript"></script>
    <style type="text/css">
    a {
        text-decoration: none;
    }
    a:visited {
        color: #000;
    }
    a:hover {
        color: #00f;
    }

    ul {
        list-style-type: none;
    }
    </style>
</head>
<body>

<div id="content">

    <p><span id="form_intro"></span></p>
    <p><small><em><span id="form_description"></span></em></small></p>

    <p>What will you do?</p>
    <ul id="choices"></ul>

    <p><em><span id="outcome"></span></em></p>

    <p>Karma <span id="karma"></span></p>
    <p>Life <span id="life"></span></p>

    <table id="items"></table>

</div>

<script type="text/javascript">

function Form() {
    this.items = {};
}

function Cell() {
    this.intro = "You are a Cell.";
    this.description = "The simplest of all organisms.";
    this.life = 10;
    this.choices = [
        makeChoice(
            "Drift",
            "You absorbed some glucose",
            0.01, -1,
            {
                "Glucose" : 1
            }),
        makeChoice(
            "Float",
            "You absorbed some oxygen",
            0.01, -1,
            {
                "Oxygen" : 1
            }),
        makeChoice(
            "Waft",
            "You produced ATP",
            0.02, -1,
            {
                "Glucose" : -2,
                "Oxygen" : -2,
                "ATP" : 1
            })
    ];
}

function Plant() {
    this.intro = "You are a Plant.";
    this.description = "Covered in leaves and bright flowers.";
    this.life = 10;
    this.choices = [
        makeChoice(
            "Sway",
            "You produce some pollen",
            1, -1,
            {
                "Pollen" : 1
            }),
        makeChoice(
            "Look pretty",
            "A bee lands on you and takes some pollen",
            1, -1,
            {
                "Pollen" : -2
            })
    ];
}

function Dog() {
    this.intro = "You are a Dog.";
    this.description = "A small and furry friend.";
    this.life = 20;
    this.choices = [
        
    ];
}

function Player(name) {
    this.karma = 0.1;
}


Form.prototype.getLife = function() {
    return this.life;
};

Form.prototype.getChoices = function() {
    return this.choices;
};


Cell.prototype = new Form;
Plant.prototype = new Form;
Dog.prototype = new Form;


function makeChoice(action, outcome, deltaKarma, deltaLife, deltaItems) {
    return {
        action : action,
        outcome : outcome,
        deltaKarma : deltaKarma,
        deltaLife : deltaLife,
        deltaItems : deltaItems
    }
}


function newForm(karma) {
    if (karma < 0.1) {
        return new Cell();
    } else if (karma < 10) {
        return new Plant();
    } else {
        return new Dog();
    }
}

function appendChoice(index, choice) {
    $('#choices').append(
        '<li><a href="#" class="choice" id=' + index + '>' + 
        choice.action +
        '</a></li>');
}

function reincarnate() {
    player.form = newForm(player.karma);

    player.life = player.form.getLife();
    player.choices = player.form.getChoices();

    $('#form_intro').text(player.form.intro);
    $('#form_description').text(player.form.description);

    $('#life').text(player.life);
    $('#karma').text(player.karma);

    var itemsOwned = {};
    var hiddenChoices = {};

    for (var i in player.choices) {
        var choice = player.choices[i];

        var print = true;
        var items = choice.deltaItems;
        for (var item in items) {
            if (items[item] < 0) {
                print = false;
            }
        }

        if (print) {
            appendChoice(i, choice);
        } else {
            hiddenChoices[i] = choice;
        }
    }
    
    $(document).on("click", ".choice", function (e) {

        var choiceID = $(this).attr('id');
        var choice = player.choices[choiceID];

        var outcome = choice.outcome;
        var deltaKarma = choice.deltaKarma;
        var deltaLife = choice.deltaLife;
        var deltaItems = choice.deltaItems;

        for (var item in deltaItems) {
            if (itemsOwned.hasOwnProperty(item)) {
                itemsOwned[item] += deltaItems[item];
            } else {
                itemsOwned[item] = deltaItems[item];
            }
        }
        

        for (var index in hiddenChoices) {
            var choice = hiddenChoices[index];

            var print = true;
            var deltaItems = choice.deltaItems;

            for (item in deltaItems) {
                if (deltaItems[item] < 0) {
                    if (itemsOwned.hasOwnProperty(item)) {
                        if (itemsOwned[item] + deltaItems[item] < 0) {
                            print = false
                        }
                    } else {
                        print = false;
                    }
                }
            }
            if (print) {
                appendChoice(index, choice);
                delete hiddenChoices[index];
            }
        }

        for (var i in player.choices) {
            var choice = player.choices[i];
            var deltaItems = choice.deltaItems;

            for (item in deltaItems) {
                if (itemsOwned.hasOwnProperty(item)) {
                    if (itemsOwned[item] + deltaItems[item] < 0) {
                        $('#' + i).remove();
                        hiddenChoices[i] = choice;
                        break;
                    }
                }
            }
        }


        $('#items').html('');

        for (var item in itemsOwned) {
            var amount = itemsOwned[item];
            $('#items').append('<tr>' +
                '<td class="item">' + item + '</td>' +
                '<td>' + amount + '</td>' +
                '</tr>');
        }

        player.karma = Math.round(
            (player.karma + deltaKarma) * 100) / 100;

        player.life += deltaLife;

        $('#life').text(player.life);
        $('#karma').text(player.karma);
        $('#outcome').text(outcome);

        if (player.life == 0) {
            $('#choices').html('');
            $('#items').html('');
            $('#outcome').text(
                'You have died and have been reincarnated.')
            reincarnate();
        } 
    });
}

var player = new Player();

reincarnate();


</script>

</body>
</html>